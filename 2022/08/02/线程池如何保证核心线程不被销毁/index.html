<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹å¦‚ä½•ä¸è¢«é”€æ¯ | ä½™å»ºæ³¢ Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta name="description" content="å¾ˆæ—©ä¹‹å‰é‚£ä¸ªæ—¶å€™ç»ƒä¹ çº¿ç¨‹æ± , å°±æ˜¯æ„Ÿè§‰çº¿ç¨‹æ± ç±»ä¼¼äº ArrayList è¿™ç§é›†åˆç±»ç»“æ„, å°† Thread ç±»å­˜å‚¨, æ¥ä»»åŠ¡äº†å°±è¿›è¡Œæ¶ˆè´¹, ç„¶é¹…â€¦ çº¿ç¨‹æ± å¹¶ä¸æ˜¯å¯¹ Thread ç›´æ¥å­˜å‚¨, è€Œæ˜¯å¯¹ Thread è¿›è¡Œäº†ä¸€å±‚åŒ…è£…, åŒ…è£…ç±»å«åš Worker">
<meta property="og:type" content="article">
<meta property="og:title" content="çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹å¦‚ä½•ä¸è¢«é”€æ¯">
<meta property="og:url" content="https://yujianbo.tech/2022/08/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E4%B8%8D%E8%A2%AB%E9%94%80%E6%AF%81/index.html">
<meta property="og:site_name" content="ä½™å»ºæ³¢ Tech">
<meta property="og:description" content="å¾ˆæ—©ä¹‹å‰é‚£ä¸ªæ—¶å€™ç»ƒä¹ çº¿ç¨‹æ± , å°±æ˜¯æ„Ÿè§‰çº¿ç¨‹æ± ç±»ä¼¼äº ArrayList è¿™ç§é›†åˆç±»ç»“æ„, å°† Thread ç±»å­˜å‚¨, æ¥ä»»åŠ¡äº†å°±è¿›è¡Œæ¶ˆè´¹, ç„¶é¹…â€¦ çº¿ç¨‹æ± å¹¶ä¸æ˜¯å¯¹ Thread ç›´æ¥å­˜å‚¨, è€Œæ˜¯å¯¹ Thread è¿›è¡Œäº†ä¸€å±‚åŒ…è£…, åŒ…è£…ç±»å«åš Worker">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-08-02T15:19:07.000Z">
<meta property="article:modified_time" content="2023-02-26T11:48:38.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="çº¿ç¨‹æ± ">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">ä½™å»ºæ³¢ Tech</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">Ã—</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      <article id="post-çº¿ç¨‹æ± å¦‚ä½•ä¿è¯æ ¸å¿ƒçº¿ç¨‹ä¸è¢«é”€æ¯" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="headline name">
      çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹å¦‚ä½•ä¸è¢«é”€æ¯
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2022-08-02T15:19:07.000Z" itemprop="datePublished">August 2, 2022, 11:19 PM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>å¾ˆæ—©ä¹‹å‰é‚£ä¸ªæ—¶å€™ç»ƒä¹ çº¿ç¨‹æ± , å°±æ˜¯æ„Ÿè§‰çº¿ç¨‹æ± ç±»ä¼¼äº ArrayList è¿™ç§é›†åˆç±»ç»“æ„, å°† Thread ç±»å­˜å‚¨, æ¥ä»»åŠ¡äº†å°±è¿›è¡Œæ¶ˆè´¹, ç„¶é¹…â€¦</p>
<p>çº¿ç¨‹æ± å¹¶ä¸æ˜¯å¯¹ Thread ç›´æ¥å­˜å‚¨, è€Œæ˜¯å¯¹ Thread è¿›è¡Œäº†ä¸€å±‚åŒ…è£…, åŒ…è£…ç±»å«åš Worker</p>
<span id="more"></span>

<h2 id="çº¿ç¨‹åŒ…è£…ç±»"><a href="#çº¿ç¨‹åŒ…è£…ç±»" class="headerlink" title="çº¿ç¨‹åŒ…è£…ç±»"></a>çº¿ç¨‹åŒ…è£…ç±»</h2><p>çº¿ç¨‹åœ¨çº¿ç¨‹æ± ä¸­çš„å­˜å‚¨ç»“æ„å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br></pre></td></tr></table></figure>

<p>å…ˆçœ‹ä¸€ä¸‹ Worker ç±»ä¸­çš„å˜é‡åŠæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ­¤çº¿ç¨‹ä¸ºçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Thread thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‡å®šçº¿ç¨‹è¿è¡Œçš„ç¬¬ä¸€é¡¹ä»»åŠ¡</span></span><br><span class="line"><span class="comment">     * ç¬¬ä¸€é¡¹ä»»åŠ¡æ²¡æœ‰åˆ™ä¸ºç©º</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">        <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿è¡Œä¼ å…¥çš„ Runnable ä»»åŠ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        runWorker(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ Worker çš„æ„é€ æ–¹æ³•å’Œé‡å†™çš„ run å¾—çŸ¥:</p>
<blockquote>
<p><strong>çº¿ç¨‹æ± æäº¤çš„ä»»åŠ¡, ä¼šç”± Worker ä¸­çš„ thread è¿›è¡Œæ‰§è¡Œè°ƒç”¨</strong></p>
</blockquote>
<h2 id="addWorker"><a href="#addWorker" class="headerlink" title="addWorker"></a>addWorker</h2><p>è¿™é‡Œè¿˜æ˜¯è¦å…ˆæ”¾ä¸€ä¸‹çº¿ç¨‹æ± çš„æ‰§è¡Œæµç¨‹ä»£ç , å…·ä½“æµç¨‹å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">      	<span class="comment">// ğŸŒŸã€é‡ç‚¹ã€‘å…³æ³¨æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹ <strong>ThreadPoolExecutor#addWorker</strong></p>
<blockquote>
<p>å’Œå¤§çº²æ²¡å…³ç³»çš„ä»£ç å’ŒçŸ¥è¯†ç‚¹ä¸ä½œè®²è§£</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// workerè¿è¡Œæ ‡è¯†</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">  	<span class="comment">// workeræ·»åŠ æ ‡è¯†</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// è°ƒç”¨Workeræ„é€ æ–¹æ³•</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">      	<span class="comment">// è·å–Workerä¸­å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN ||</span><br><span class="line">                        (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive())</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line">                  	<span class="comment">// å¦‚æ— å¼‚å¸¸, å°†wæ·»åŠ è‡³workers</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                      	<span class="comment">// æ›´æ–°æ± å†…æœ€å¤§çº¿ç¨‹</span></span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">              	<span class="comment">// å¯åŠ¨Wokerä¸­threadå·¥ä½œçº¿ç¨‹</span></span><br><span class="line">                t.start();</span><br><span class="line">              	<span class="comment">// è®¾ç½®å¯åŠ¨æˆåŠŸæ ‡è¯†æˆåŠŸ</span></span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœå¯åŠ¨å¤±è´¥æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢, å°†Workerä»workersä¸­ç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (!workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦ç€é‡å…³å¿ƒä¸‹ <strong>t.start()</strong>, t æ˜¯æˆ‘ä»¬ Worker ä¸­çš„å·¥ä½œçº¿ç¨‹</p>
<p>ä¸Šæ–‡è¯´åˆ° Worker å®ç°äº† Runnable æ¥å£, å¹¶é‡å†™äº† run æ–¹æ³•, æ‰€ä»¥ t.start()</p>
<p><strong>æœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨ Worker ä¸­çš„ run()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    runWorker(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="runWorker"><a href="#runWorker" class="headerlink" title="runWorker"></a>runWorker</h2><p><strong>ThreadPoolExecutor#runWorker</strong> æ˜¯å…·ä½“æ‰§è¡Œçº¿ç¨‹æ± æäº¤ä»»åŠ¡çš„æ–¹æ³•, å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š</p>
<p>1ã€è·å– Worker ä¸­çš„ç¬¬ä¸€ä¸ªä»»åŠ¡</p>
<p>2ã€å¦‚æœç¬¬ä¸€ä¸ªä»»åŠ¡ä¸ä¸ºç©ºåˆ™æ‰§è¡Œå…·ä½“æµç¨‹</p>
<p>3ã€ç¬¬ä¸€ä¸ªä»»åŠ¡ä¸ºç©ºåˆ™ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡, è¿™ä¸€ç‚¹ä¹Ÿæ˜¯æ ¸å¿ƒçº¿ç¨‹ä¸è¢«å›æ”¶çš„å…³é”®</p>
<p>runWorker() ä¸­æœ‰ä¸¤ä¸ªæ‰©å±•æ–¹æ³•, <strong>beforeExecuteã€afterExecute</strong>, åœ¨ä»»åŠ¡æ‰§è¡Œå‰åè¾“å‡ºä¸€äº›é‡è¦ä¿¡æ¯, å¯ç”¨ä½œä¸ç›‘æ§ç­‰â€¦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// ğŸŒŸã€é‡ç‚¹ã€‘getTask() æ˜¯æ ¸å¿ƒçº¿ç¨‹ä¸è¢«å›æ”¶çš„ç²¾é«“</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            w.lock();</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; ...</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          			<span class="comment">// ğŸŒŸã€é‡ç‚¹ã€‘æ‰§è¡Œå®Œä»»åŠ¡å, å°†Taskç½®ç©º</span></span><br><span class="line">                task = <span class="literal">null</span>;</span><br><span class="line">                w.completedTasks++;</span><br><span class="line">                w.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  			<span class="comment">// é€€å‡ºWorker</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é”®å…³æ³¨ä¸‹ while å¾ªç¯, å†…éƒ¨ä¼šåœ¨æ‰§è¡Œå®Œæµç¨‹åå°† task è®¾ç½®ä¸ºç©º, è¿™æ ·å°±ä¼šè·³å‡ºå¾ªç¯</p>
<p>å¯ä»¥çœ‹åˆ° <strong>processWorkerExit</strong> æ˜¯åœ¨ finally è¯­å¥å—ä¸­, ç›¸å½“äº <strong>è·å–ä¸åˆ°é˜»å¡é˜Ÿåˆ—ä»»åŠ¡å°±ä¼šå»å…³é—­ Worker</strong></p>
<p>çº¿ç¨‹æ± æ˜¯å¦‚ä½•ä¿è¯æ ¸å¿ƒçº¿ç¨‹è·å–ä¸åˆ°ä»»åŠ¡æ—¶ä¸è¢«é”€æ¯å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ getTask() ä¸­æ˜¯å¦‚ä½•è·å–ä»»åŠ¡</p>
<h2 id="getTask"><a href="#getTask" class="headerlink" title="getTask"></a>getTask</h2><p><strong>ThreadPoolExecutor#getTask</strong> åªåšäº†ä¸€ä»¶äº‹æƒ…, å°±æ˜¯ä»çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡è¿”å›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timedOut</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if queue empty only if necessary.</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span><br><span class="line">                &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                    workQueue.take();</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            timedOut = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            timedOut = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="timed"><a href="#timed" class="headerlink" title="timed"></a>timed</h3><p>é‡ç‚¹ä»£ç ä»ä¸Šé¢æˆªå‡ºæ¥, é¦–å…ˆæ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦è·å–é˜»å¡é˜Ÿåˆ—ä»»åŠ¡æ—¶åœ¨è§„å®šæ—¶é—´è¿”å›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ã€é‡ç‚¹ã€‘åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¶…æ—¶, è¿™é‡Œä¼šé’ˆå¯¹ä¸¤ç§æƒ…å†µåˆ¤æ–­</span></span><br><span class="line"><span class="comment"> * 1. è®¾ç½®allowCoreThreadTimeOutå‚æ•°é»˜è®¤false</span></span><br><span class="line"><span class="comment"> *    å¦‚æœä¸ºtrueè¡¨ç¤ºæ ¸å¿ƒçº¿ç¨‹ä¹Ÿä¼šè¿›è¡Œè¶…æ—¶å›æ”¶</span></span><br><span class="line"><span class="comment"> * 2. åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çš„æ•°é‡æ˜¯å¦å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿™é‡Œå‚ä¸äº†æˆ–è¿ç®—ç¬¦, åªè¦å…¶ä¸­ä¸€ä¸ªåˆ¤æ–­ç¬¦åˆå³ä¸ºTrue</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ® timed å±æ€§, åˆ¤æ–­è·å–é˜»å¡é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„æ–¹å¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ã€é‡ç‚¹ã€‘æ ¹æ®timedåˆ¤æ–­ä¸¤ç§ä¸åŒæ–¹å¼çš„ä»»åŠ¡è·å–</span></span><br><span class="line"><span class="comment"> * 1. å¦‚æœä¸ºTrue, è¡¨ç¤ºçº¿ç¨‹ä¼šæ ¹æ®è§„å®šæ—¶é—´è°ƒç”¨é˜»å¡é˜Ÿåˆ—ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> * 2. å¦‚æœä¸ºFalse, è¡¨ç¤ºçº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡è°ƒç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">		workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">		workQueue.take();</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ¯”è¾ƒæ¸…æ¥šäº†, å¦‚æœ timed ä¸º True, çº¿ç¨‹ç»è¿‡ <strong>éæ ¸å¿ƒçº¿ç¨‹è¿‡æœŸæ—¶é—´åè¿˜æ²¡æœ‰è·å–åˆ°ä»»åŠ¡</strong>, åˆ™æ–¹æ³•ç»“æŸ, åç»­ä¼šå°† Worker è¿›è¡Œå›æ”¶</p>
<p>å¦‚æœæ²¡æœ‰è®¾ç½® allowCoreThreadTimeOut ä¸º True, ä»¥åŠå½“å‰çº¿ç¨‹æ± å†…çº¿ç¨‹æ•°é‡ä¸å¤§äºæ ¸å¿ƒçº¿ç¨‹</p>
<p>é‚£ä¹ˆä»é˜»å¡é˜Ÿåˆ—è·å–çš„è¯æ˜¯ take(), take() ä¼š <strong>ä¸€ç›´é˜»å¡, ç­‰å¾…ä»»åŠ¡çš„æ·»åŠ è¿”å›</strong></p>
<p>è¿™æ ·ä¹Ÿå°±é—´æ¥è¾¾åˆ°äº†æ ¸å¿ƒçº¿ç¨‹æ•°ä¸ä¼šè¢«å›æ”¶çš„æ•ˆæœ</p>
<h2 id="æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹åŒºåˆ«"><a href="#æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹åŒºåˆ«" class="headerlink" title="æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹åŒºåˆ«"></a>æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹åŒºåˆ«</h2><p>æ ¸å¿ƒçº¿ç¨‹åªæ˜¯ä¸€ä¸ªå«æ³•, æ ¸å¿ƒçº¿ç¨‹ä¸éæ ¸å¿ƒçº¿ç¨‹çš„åŒºåˆ«æ˜¯:</p>
<p><strong>åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ—¶ä¼šæºå¸¦ä¸€ä¸ªä»»åŠ¡, è€Œéæ ¸å¿ƒçº¿ç¨‹æ²¡æœ‰</strong></p>
<p>å¦‚æœæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œå®Œç¬¬ä¸€ä¸ªä»»åŠ¡, çº¿ç¨‹æ± å†…çº¿ç¨‹æ— åŒºåˆ«</p>
<p><strong>çº¿ç¨‹æ± æ˜¯æœŸæœ›è¾¾åˆ° corePoolSize çš„å¹¶å‘çŠ¶æ€</strong>, ä¸å…³å¿ƒæœ€å…ˆæ·»åŠ åˆ°çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ˜¯å¦ä¼šè¢«é”€æ¯</p>

      
    </div>
    
    
    <div class="article-category">
      
        <b>Categories:</b>
        <a class="article-category-link" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">å¹¶å‘ç¼–ç¨‹</a>
      
      
        <br/>
      
      
        <b>Tags:</b>
        <a class="article-tag-none-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">çº¿ç¨‹æ± </a>
      
    </div>
    
    
  </div>
</article>

  
<nav id="article-nav" class="article-nav">
  
    <a href="/2022/12/02/%E4%BB%80%E4%B9%88%E6%98%AF%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          å¹¶å‘ç¼–ç¨‹ä¹‹é˜»å¡é˜Ÿåˆ—
        
      </div>
    </a>
  
  
    <a href="/2022/08/02/%E4%BB%80%E4%B9%88%E6%98%AFAQS/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          å¹¶å‘ç¼–ç¨‹ä¹‹AQSé‚£äº›äº‹
        
      </div>
    </a>
  
</nav>






    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
