<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>AtomicåŸå­å¹¶å‘ç¼–ç¨‹ | ä½™å»ºæ³¢ Tech</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta name="description" content="å¦‚æœè¦èŠåŸå­ç±»ç›¸å…³çš„è¯é¢˜, å¯ä»¥å…ˆä»åŸºæœ¬çš„æ¦‚å¿µå¼€å§‹ 1ã€åŸå­ç±»ä¸ºäº†è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜? ç­”: ä¸ºäº†è§£å†³å¹¶å‘åœºæ™¯ä¸‹æ— é”çš„æ–¹å¼ä¿è¯å•ä¸€å˜é‡çš„æ•°æ®ä¸€è‡´æ€§">
<meta property="og:type" content="article">
<meta property="og:title" content="AtomicåŸå­å¹¶å‘ç¼–ç¨‹">
<meta property="og:url" content="https://yujianbo.tech/2022/07/07/JUC%E5%8E%9F%E5%AD%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/index.html">
<meta property="og:site_name" content="ä½™å»ºæ³¢ Tech">
<meta property="og:description" content="å¦‚æœè¦èŠåŸå­ç±»ç›¸å…³çš„è¯é¢˜, å¯ä»¥å…ˆä»åŸºæœ¬çš„æ¦‚å¿µå¼€å§‹ 1ã€åŸå­ç±»ä¸ºäº†è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜? ç­”: ä¸ºäº†è§£å†³å¹¶å‘åœºæ™¯ä¸‹æ— é”çš„æ–¹å¼ä¿è¯å•ä¸€å˜é‡çš„æ•°æ®ä¸€è‡´æ€§">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/%E5%A5%BD%E7%BE%9E%E8%80%BB%E5%95%8A.png">
<meta property="og:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930201842632.png">
<meta property="og:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202236455.png">
<meta property="og:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202400022.png">
<meta property="og:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202633665.png">
<meta property="og:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202827344.png">
<meta property="article:published_time" content="2022-07-07T13:19:07.000Z">
<meta property="article:modified_time" content="2023-02-26T11:51:21.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="åŸå­å¹¶å‘">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://images-machen.oss-cn-beijing.aliyuncs.com/%E5%A5%BD%E7%BE%9E%E8%80%BB%E5%95%8A.png"><meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">ä½™å»ºæ³¢ Tech</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">Ã—</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      <article id="post-JUCåŸå­å¹¶å‘ç¼–ç¨‹" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="headline name">
      AtomicåŸå­å¹¶å‘ç¼–ç¨‹
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2022-07-07T13:19:07.000Z" itemprop="datePublished">July 7, 2022, 9:19 PM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>å¦‚æœè¦èŠåŸå­ç±»ç›¸å…³çš„è¯é¢˜, å¯ä»¥å…ˆä»åŸºæœ¬çš„æ¦‚å¿µå¼€å§‹</p>
<p><strong>1ã€åŸå­ç±»ä¸ºäº†è§£å†³ä»€ä¹ˆæ ·çš„é—®é¢˜?</strong></p>
<p>ç­”: ä¸ºäº†è§£å†³å¹¶å‘åœºæ™¯ä¸‹æ— é”çš„æ–¹å¼ä¿è¯å•ä¸€å˜é‡çš„æ•°æ®ä¸€è‡´æ€§</p>
<span id="more"></span>

<p><strong>2ã€ä»€ä¹ˆæƒ…å†µä¸‹å­˜åœ¨å¹¶å‘é—®é¢˜?</strong></p>
<p>ç­”: å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™åŒä¸€ä¸ªå…±äº«æ•°æ®æ—¶å­˜åœ¨å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜</p>
<p>è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜çš„æ–¹å¼æœ‰å¾ˆå¤šç§æ–¹å¼, <strong>è‘—åçš„å°±æ˜¯ JDK å¹¶å‘åŒ… concurrent</strong>, ä¸ºäº†å¹¶å‘è€Œå­˜åœ¨çš„</p>
<h2 id="éåŸå­è®¡ç®—"><a href="#éåŸå­è®¡ç®—" class="headerlink" title="éåŸå­è®¡ç®—"></a>éåŸå­è®¡ç®—</h2><p>å¤§å®¶åº”è¯¥éƒ½çŸ¥é“, ç±»ä¼¼äºä»£ç ä¸­çš„ i++ æ“ä½œ, è™½ç„¶æ˜¯ä¸€è¡Œ, ä½†æ˜¯æ‰§è¡Œæ—¶å€™æ˜¯åˆ†ä¸ºä¸‰æ­¥çš„</p>
<ul>
<li>ä»ä¸»å­˜è·å–å˜é‡ i</li>
<li>å˜é‡ i å€¼+1</li>
<li>æ–°å¢åå˜é‡ i å€¼å†™å›ä¸»å­˜</li>
</ul>
<p>å†™ä¸ªå°ç¨‹åºæ¥æ›´å¥½çš„ç†è§£, ä¸è®ºæˆ‘ä»¬æ€ä¹ˆè¿è¡Œä¸‹æ–¹ç¨‹åº, 99% ä»¥ä¸Šæ¦‚ç‡ä¸ä¼šåˆ°è¾¾ 100000000</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">NUM</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                NUM++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(NUM);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 99149419</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ä½¿ç”¨ JDK è‡ªå¸¦çš„ synchronized, é€šè¿‡ <strong>äº’æ–¥é”çš„æ–¹å¼</strong> åŒæ­¥æ‰§è¡Œ NUM++ è¿™ä¸ªä»£ç å—</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">NUM</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (Object.class) &#123;</span><br><span class="line">                    NUM++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(NUM);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 100000000</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰é¢ä¸€ç›´åœ¨è¯´é”, å†™ç€ AtomicInteger åœ¨è¿™è¯´é”çš„é—®é¢˜, å’±ä¸èƒ½æŒ‚ç€ç¾Šçš®å–ç‹—è‚‰æ˜¯å§</p>
<p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/%E5%A5%BD%E7%BE%9E%E8%80%BB%E5%95%8A.png"></p>
<p>å¦‚æœçœ‹è¿‡ JDK æºç  JUC åŒ…ä¸‹çš„ç±»åº“æºä»£ç , å…³äº <strong>Atomic å¼€å¤´çš„ç±»åº“</strong> åº”è¯¥ä¸ä¼šé™Œç”Ÿ</p>
<blockquote>
<p>Atomic è‹± [É™ËˆtÉ’mÉªk] ç¾ [É™ËˆtÉ‘ËmÉªk] ç¿»è¯‘ : åŸå­çš„</p>
</blockquote>
<p>å¦‚æœä¸ä½¿ç”¨é”æ¥è§£å†³ä¸Šé¢çš„éåŸå­è‡ªå¢é—®é¢˜, å¯ä»¥è¿™ä¹ˆæ¥å†™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">NUM</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">              	<span class="comment">// ğŸš© é‡ç‚¹å“¦, è‡ªå¢å¹¶è·å–æ–°å€¼</span></span><br><span class="line">                NUM.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(NUM);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 100000000</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="AtomicInteger-ç®€ä»‹"><a href="#AtomicInteger-ç®€ä»‹" class="headerlink" title="AtomicInteger ç®€ä»‹"></a>AtomicInteger ç®€ä»‹</h2><p>çœ‹åˆ°ä¸€ä¸ªæŠ€æœ¯ç‚¹æˆ–è€…æ¡†æ¶ä¹‹ç±»æ¯”è¾ƒæ–°é¢–çš„çŸ¥è¯†, ä¸€èˆ¬ä¼šæ€è€ƒä¸¤ä¸ªé—®é¢˜</p>
<h3 id="å®ƒæ˜¯ä»€ä¹ˆ"><a href="#å®ƒæ˜¯ä»€ä¹ˆ" class="headerlink" title="å®ƒæ˜¯ä»€ä¹ˆ"></a>å®ƒæ˜¯ä»€ä¹ˆ</h3><p>AtomicInteger æ˜¯ JDK å¹¶å‘åŒ…ä¸‹æä¾›çš„ <strong>æ“ä½œ Integer ç±»å‹åŸå­ç±»</strong>, é€šè¿‡è°ƒç”¨åº•å±‚ <strong>Unsafe çš„ CAS ç›¸å…³æ–¹æ³•å®ç°åŸå­æ“ä½œ</strong></p>
<p>åŸºäºä¹è§‚é”çš„æ€æƒ³å®ç°çš„ä¸€ç§æ— é”åŒ–åŸå­æ“ä½œ, <strong>ä¿éšœäº†å¤šçº¿ç¨‹æƒ…å†µä¸‹å•ä¸€å˜é‡çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</strong></p>
<blockquote>
<p>å…³äº CAS çš„æ¦‚å¿µä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜</p>
</blockquote>
<h3 id="æœ‰ä»€ä¹ˆä¼˜ç‚¹"><a href="#æœ‰ä»€ä¹ˆä¼˜ç‚¹" class="headerlink" title="æœ‰ä»€ä¹ˆä¼˜ç‚¹"></a>æœ‰ä»€ä¹ˆä¼˜ç‚¹</h3><p>AtmoicInteger ä½¿ç”¨ç¡¬ä»¶çº§åˆ«çš„æŒ‡ä»¤ CAS æ¥æ›´æ–°è®¡æ•°å™¨çš„å€¼, æœºå™¨ç›´æ¥æ”¯æŒçš„æŒ‡ä»¤, <strong>è¿™æ ·å¯ä»¥é¿å…åŠ é”</strong></p>
<p>æ¯”å¦‚åƒäº’æ–¥é” synchronized åœ¨å¹¶å‘æ¯”è¾ƒä¸¥é‡æƒ…å†µä¸‹, ä¼šå°†é” <strong>å‡çº§åˆ°é‡é‡çº§é”</strong></p>
<p>å”¤é†’ä¸é˜»å¡çº¿ç¨‹æ—¶ä¼šæœ‰ä¸€ä¸ª <strong>ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„ä¸€ä¸ªè½¬å˜</strong>, è€Œè½¬æ¢çŠ¶æ€æ˜¯éœ€è¦æ¶ˆè€—å¾ˆå¤šæ—¶é—´çš„</p>
<blockquote>
<p>å†™è¿‡ç¨‹åºè¿›è¡Œæµ‹è¯•, å°½ç®¡ synchronized ç»è¿‡å‡çº§å, æ€§èƒ½æœ‰äº†å¤§å¹…åº¦æå‡, ä½†åœ¨ <strong>ä¸€èˆ¬å¹¶å‘åœºæ™¯ä¸‹, CAS æ— é”ç®—æ³•æ€§èƒ½æ›´é«˜ä¸€äº›</strong></p>
</blockquote>
<p>å½“ç„¶ä¸å¯èƒ½ä¼šæœ‰å°½å–„å°½ç¾çš„å­˜åœ¨, å…³äº CAS æ— é”ç®—æ³•ä¼šåœ¨ä¸‹é¢è¯´æ˜åŠ£åŠ¿æ‰€åœ¨</p>
<h2 id="ç»“æ„åˆ†æ"><a href="#ç»“æ„åˆ†æ" class="headerlink" title="ç»“æ„åˆ†æ"></a>ç»“æ„åˆ†æ</h2><p>AtomicInteger æœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•, åˆ†åˆ«æ˜¯ä¸€ä¸ªæ— å‚æ„é€ åŠæœ‰å‚æ„é€ </p>
<ul>
<li>æ— å‚æ„é€ çš„ value å°±æ˜¯ int çš„é»˜è®¤å€¼ 0</li>
<li>æœ‰å‚æ„é€ ä¼šå°† value èµ‹å€¼</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AtomicInteger</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AtomicInteger</span><span class="params">(<span class="type">int</span> initialValue)</span> &#123;</span><br><span class="line">    value = initialValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AtomicInteger æœ‰ä¸‰ä¸ªé‡è¦çš„å˜é‡, åˆ†åˆ«æ˜¯:</p>
<p><strong>Unsafe:</strong> å¯ä»¥ç†è§£å®ƒå¯¹äº Java è€Œè¨€, æ˜¯ä¸€ä¸ª â€œBUGâ€ çš„å­˜åœ¨, åœ¨ AtomicInteger é‡Œçš„æœ€å¤§ä½œç”¨å°±æ˜¯ç›´æ¥æ“ä½œå†…å­˜è¿›è¡Œå€¼æ›¿æ¢</p>
<p><strong>value:</strong> ä½¿ç”¨ int ç±»å‹å­˜å‚¨ AtomicInteger è®¡ç®—çš„å€¼, é€šè¿‡ volatile è¿›è¡Œä¿®é¥°, <strong>æä¾›äº†å†…å­˜å¯è§æ€§åŠé˜²æ­¢æŒ‡ä»¤é‡æ’åº</strong></p>
<p><strong>valueOffset:</strong> value çš„å†…å­˜åç§»é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–Unsafeå®ä¾‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€ä»£ç å—ï¼Œåœ¨ç±»åŠ è½½æ—¶è¿è¡Œ</span></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      	<span class="comment">// è·å– value çš„å†…å­˜åç§»é‡</span></span><br><span class="line">        valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç½—åˆ—å‡ºä¸€äº›å¸¸ç”¨ API, æ ¸å¿ƒå®ç°æ€è·¯éƒ½æ˜¯ä¸€è‡´çš„, ä¼šç€é‡è®²å…¶ä¸­ä¸€ä¸ª</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰ value å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">get</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å–å½“å‰çš„å€¼, å¹¶è®¾ç½®æ–°çš„å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> newValue)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰çš„å€¼, å¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAdd</span><span class="params">(<span class="type">int</span> delta)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰å€¼, å¹¶è¿›è¡Œè‡ªå¢1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰å€¼, å¹¶è¿›è¡Œè‡ªå‡1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndDecrement</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>è·å–å½“å‰å€¼å¹¶è‡ªå¢ #getAndIncrement()</strong></p>
<p>çœ‹ä¸€ä¸‹å…·ä½“åœ¨æºç ä¸­æ˜¯å¦‚ä½•æ“ä½œçš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndIncrement</span><span class="params">()</span> &#123;</span><br><span class="line">  	<span class="keyword">return</span> unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * unsafe.getAndAddInt</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var1 AtomicInteger å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var2 value å†…å­˜åç§»é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var4 å¢åŠ çš„å€¼, æ¯”å¦‚åœ¨åŸæœ‰å€¼ä¸Š + 1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAddInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4)</span> &#123;</span><br><span class="line">    <span class="type">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// å†…å­˜ä¸­ value æœ€æ–°å€¼</span></span><br><span class="line">        var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°±æ˜¯ CAS ä½“ç°æ— é”ç®—æ³•çš„åœ°æ–¹, å…ˆæ¥è¯´ä¸‹è¿™æ®µä»£ç çš„æ‰§è¡Œæ­¥éª¤</p>
<p>1ã€æ ¹æ® AtomicInteger å¯¹è±¡ ä»¥åŠ value å†…å­˜åç§»é‡è·å–å¯¹åº” value æœ€æ–°å€¼</p>
<p>2ã€é€šè¿‡ compareAndSwapInt(â€¦) å°†å†…å­˜ä¸­çš„å€¼(var5)æ›´æ”¹ä¸ºæœŸæœ›çš„å€¼ (var5+var4), ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰æˆåŠŸä¿®æ”¹è¿”å› True ç»“æŸå¾ªç¯, Flase ç»§ç»­æ‰§è¡Œå¾ªç¯</p>
<p>ç²¾é«“çš„åœ°æ–¹å°±åœ¨äº <strong>compareAndSwapInt(â€¦)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¯”è¾ƒ var1 çš„ var2 å†…å­˜åç§»é‡å¤„çš„å€¼æ˜¯å¦å’Œ var4 ç›¸ç­‰, ç›¸ç­‰åˆ™æ›´æ–°ä¸º var5</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var1 AtomicInteger å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var2 value å†…å­˜åç§»é‡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var4 value åŸæœ¬çš„å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> var5 æœŸæœ›å°† value è®¾ç½®çš„å€¼</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4, <span class="type">int</span> var5)</span>;</span><br></pre></td></tr></table></figure>

<p>ç”±äºæ˜¯ native å…³é”®å­—ä¿®é¥°, æˆ‘ä»¬æ— æ³•æŸ¥çœ‹å…¶æºç , è¯´æ˜ä¸€ä¸‹æ–¹æ³•æ€è·¯</p>
<p>1ã€é€šè¿‡ var1(AtomicInteger) è·å–åˆ° var2 (å†…å­˜åç§»é‡) çš„ value å€¼</p>
<p>2ã€å°† value(å†…å­˜ä¸­å€¼) ä¸ var4(çº¿ç¨‹å†…è·å–çš„ value å€¼) è¿›è¡Œæ¯”è¾ƒ</p>
<p>3ã€å¦‚æœç›¸ç­‰å°† var5(æœŸæœ›å€¼) è®¾ç½®ä¸ºå†…å­˜ä¸­æ–°çš„ value å¹¶è¿”å› True</p>
<p>4ã€ä¸ç›¸ç­‰è¿”å› False ç»§ç»­å°è¯•æ‰§è¡Œå¾ªç¯</p>
<h2 id="å›¾æ–‡åˆ†æ-CAS"><a href="#å›¾æ–‡åˆ†æ-CAS" class="headerlink" title="å›¾æ–‡åˆ†æ CAS"></a>å›¾æ–‡åˆ†æ CAS</h2><p>è¿™é‡Œç»™å‡ºä¸€ç»„å›¾ç‰‡è¿›ä¸€æ­¥ç†è§£ CAS</p>
<p><strong>Unsafe#getAndAddInt()</strong> ä»¥æ­¤æ–¹æ³•ä¸ºä¾‹</p>
<p>1ã€è¿™ä¸ªå›¾ç‰‡ç›¸å½“äº AtomicInteger å¯¹è±¡å¯¹åº”çš„ valueOffset ä½ç½®</p>
<p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930201842632.png"></p>
<p>2ã€çº¿ç¨‹ä¸€æ‰§è¡Œ var5 &#x3D; this.getIntVolatile(var1, var2)</p>
<p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202236455.png"></p>
<p>3ã€çº¿ç¨‹äºŒæ‰§è¡Œ var5 &#x3D; this.getIntVolatile(var1, var2)</p>
<p>æ­¤æ—¶åœ¨çº¿ç¨‹ä¸€ã€äºŒçš„å·¥ä½œå†…å­˜ä¸­ var5 éƒ½æ˜¯ 0</p>
<p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202400022.png"></p>
<p>4ã€çº¿ç¨‹ä¸€æ¬²ä¿®æ”¹å†…å­˜ä¸­çš„ value ä¸º 1, é€šè¿‡æ¯”å¯¹ var4 ä¸å†…å­˜ä¸­çš„å€¼ç›¸ç­‰, å†…å­˜å€¼æˆåŠŸè¢«è®¾ç½®æˆ 1</p>
<p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202633665.png"></p>
<p>5ã€çº¿ç¨‹äºŒä¹Ÿæ˜¯è¦ä¿®æ”¹å†…å­˜ä¸­å¯¹åº”çš„ value å€¼, å‘ç°å·²ç»ä¸ç›¸ç­‰äº†, è¿”å› False ç»§ç»­å°è¯•ä¿®æ”¹</p>
<p><img src="https://images-machen.oss-cn-beijing.aliyuncs.com/image-20200930202827344.png"></p>
<h2 id="ä¸è¶³ä¹‹å¤„"><a href="#ä¸è¶³ä¹‹å¤„" class="headerlink" title="ä¸è¶³ä¹‹å¤„"></a>ä¸è¶³ä¹‹å¤„</h2><p>CAS è™½ç„¶èƒ½å¤Ÿå®ç°æ— é”ç¼–ç¨‹, åœ¨ä¸€èˆ¬æƒ…å†µä¸‹å¯¹æ€§èƒ½åšå‡ºäº†æå‡, ä½†æ˜¯å¹¶ä¸æ˜¯æ²¡æœ‰å±€é™æ€§æˆ–ç¼ºç‚¹</p>
<p><strong>1ã€CPU è‡ªæ—‹å¼€é”€è¾ƒå¤§</strong></p>
<p>åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹, è‡ªæ—‹ CAS å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸ, ä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€</p>
<blockquote>
<p>å¦‚æœæ˜¯å®ç°é«˜å¹¶å‘ä¸‹çš„è®¡æ•°, å¯ä»¥ä½¿ç”¨ LongAdder, è®¾è®¡çš„é«˜å¹¶å‘æ€æƒ³çœŸçš„å¼º!</p>
</blockquote>
<p><strong>2ã€è‘—åçš„ â€œABAâ€ é—®é¢˜</strong></p>
<p>CAS éœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™æ£€æŸ¥ä¸‹å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–, å¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°</p>
<p>ä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯ A, å˜æˆäº† B, åˆå˜æˆäº† A, é‚£ä¹ˆä½¿ç”¨ CAS è¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–, ä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†</p>
<p>å¦‚æœæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»çœ‹ä¸‹ JUCA åŸå­åŒ…ä¸‹çš„ <strong>AtomicStampedReference</strong></p>

      
    </div>
    
    
    <div class="article-category">
      
        <b>Categories:</b>
        <a class="article-category-link" href="/categories/JUC/">JUC</a>
      
      
        <br/>
      
      
        <b>Tags:</b>
        <a class="article-tag-none-link" href="/tags/%E5%8E%9F%E5%AD%90%E5%B9%B6%E5%8F%91/" rel="tag">åŸå­å¹¶å‘</a>
      
    </div>
    
    
  </div>
</article>

  
<nav id="article-nav" class="article-nav">
  
    <a href="/2022/08/02/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%A0%B8%E5%BF%83%E7%BA%BF%E7%A8%8B%E4%B8%8D%E8%A2%AB%E9%94%80%E6%AF%81/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹å¦‚ä½•ä¸è¢«é”€æ¯
        
      </div>
    </a>
  
  
    <a href="/2022/06/02/%E7%BA%BF%E4%B8%8AFastThrow/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          çº¿ä¸Šæ•…éšœæ— æŠ¥é”™ä¿¡æ¯è®°å½•
        
      </div>
    </a>
  
</nav>






    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
